<nb-layout>
    <nb-layout-column>

        <nb-card class="global-card" status="primary">
            <nb-card-header>
                GLOBAL SETTINGS
            </nb-card-header>
            <nb-card-body>
                <nb-accordion>
                    <nb-accordion-item>
                        <nb-accordion-item-header>
                            VIEWPORT
                        </nb-accordion-item-header>
                        <nb-accordion-item-body>
                            <nb-list>
                                <nb-list-item>
                                    Browser source url:
                                    &nbsp;
                                    <a [href]="viewport.url" target="_blank">{{viewport.url}}</a>
                                </nb-list-item>
                                <nb-list-item>
                                    Browser source size:
                                    &nbsp;
                                    {{viewport.width}}&nbsp;x&nbsp;{{viewport.height}}&nbsp;px
                                </nb-list-item>
                                <nb-list-item>
                                    Browser source padding:
                                    &nbsp;
                                    {{viewport.padding}}&nbsp;px
                                </nb-list-item>
                            </nb-list>
                        </nb-accordion-item-body>
                    </nb-accordion-item>
                </nb-accordion>
            </nb-card-body>
        </nb-card>

        <nb-accordion multi>
            <nb-accordion-item *ngFor="let elem of elements" [expanded]="elem.expanded" class="element-entry">
                <nb-accordion-item-header>
                    <button nbButton status="primary" (click)="sendTestEvent($event, elem)"><nb-icon icon="cast"></nb-icon></button>
                    <div class="element-name">
                        {{elem.name}}
                    </div>
                    <div class="element-details">
                        <div *ngFor="let c of elem.conditions; let i = index" style="white-space: pre-line;">
                            <strong>{{ConditionTypes[c.type]}}</strong> {{AllOperators[c.operator]}} {{c.compared.title ? c.compared.title : _UserTypes.includes(c.compared+'') ?  UserTypes[c.compared] : c.compared}}
                            <strong *ngIf="i+1 < elem.conditions.length">&nbsp;AND&nbsp;</strong>
                        </div>
                    </div>
                </nb-accordion-item-header>
                <nb-accordion-item-body>
                    <nb-card class="element-card">
                        <nb-card-header class="conditions-header">                           
                            <nb-list>
                                <nb-list-item *ngFor="let c of elem.conditions" class="conditions-entry">

                                    <nb-select [(selected)]="c.type" (selectedChange)="elem.changes=true">
                                        <nb-option *ngFor="let type of ConditionTypes | keyvalue" [value]=type.key>{{type.value}}</nb-option>
                                    </nb-select>
                                
                                    <nb-select *ngIf="c.type!=='user' && c.type!=='redeem'" [(selected)]="c.operator" (selectedChange)="elem.changes=true" size="small">
                                        <nb-option *ngFor="let op of ComparisonOperators | keyvalue" [value]=op.key>{{op.value}}</nb-option>
                                    </nb-select>
                                    <nb-select *ngIf="c.type==='user'" [(selected)]="c.operator" (selectedChange)="elem.changes=true" size="small">
                                        <nb-option *ngFor="let op of UserOperators | keyvalue" [value]=op.key>{{op.value}}</nb-option>
                                        <nb-option *ngFor="let op of UserTypeOperators | keyvalue" [value]=op.key>{{op.value}}</nb-option>
                                    </nb-select>
                                    <nb-select *ngIf="c.type==='redeem'" [(selected)]="c.operator" (selectedChange)="elem.changes=true" size="small">
                                        <nb-option *ngFor="let op of RedemptionOperators | keyvalue" [value]=op.key>{{op.value}}</nb-option>
                                    </nb-select>

                                    <input *ngIf="!c.operator.startsWith('type') && c.operator !== 'redeemed'" nbInput [type]="c.type==='user' ? 'text' : 'number'" [(ngModel)]="c.compared" (change)="elem.changes=true">
                                    <nb-select *ngIf="c.operator.startsWith('type')" [(selected)]="c.compared" (selectedChange)="elem.changes=true">
                                        <nb-option *ngFor="let ut of UserTypes | keyvalue" [value]=ut.key>{{ut.value}}</nb-option>
                                    </nb-select>
                                    <nb-select *ngIf="c.operator === 'redeemed'" [(selected)]="c.compared" (selectedChange)="elem.changes=true">
                                        <nb-option *ngFor="let r of channelRewards" [value]=r>{{r.title}}</nb-option>
                                    </nb-select>

                                    <button nbButton status="danger" [disabled]="elem.conditions.length<2" (click)="deleteCondition(elem, c)"><nb-icon icon="trash-2"></nb-icon></button>
                                </nb-list-item>
                        
                                <nb-list-item>
                                    <button nbButton status="primary" (click)="addCondition(elem)">ADD CONDITION</button>
                                    <input nbInput [(ngModel)]="elem.name" fullWidth style="margin-left:1rem">
                                </nb-list-item>
                            </nb-list>
                        </nb-card-header>

                        <nb-card-body class="events-body">
                            <nb-tabset fullWidth>
                                <nb-tab *ngFor="let ev of elem.events; let i = index" [tabTitle]="ev.type">

                                    <div #videoaudio *ngIf="ev.type==='video' || ev.type==='audio'" class="video-container">
                                        
                                        <div *ngIf="ev.src && ev.type==='video'" class="video-preview">
                                            <video style="width: 100%; height: 100%;" (loadeddata)="onLoadedData(ev, $event)" autoplay loop [muted]="'muted'">
                                                <source [src]="ev.src">
                                            </video>  
                                            <button nbButton class="video-delete" status="danger" (click)="deleteVideoSrc(elem, ev, ev.src)"><nb-icon icon="trash-2"></nb-icon></button>
                                        </div>
                                        <div *ngIf="ev.src && ev.type==='audio'" class="video-preview">
                                            <audio (loadeddata)="onLoadedData(ev, $event)" controls>
                                                <source *ngIf="ev.src" [src]="ev.src">
                                            </audio>
                                            <button nbButton class="video-delete" status="danger" (click)="deleteVideoSrc(elem, ev, ev.src)"><nb-icon icon="trash-2"></nb-icon></button>
                                        </div>

                                        <div *ngIf="!ev.src" class="video-uploader">
                                            <nb-select placeholder="Select a video" *ngIf="ev.select && ev.type==='video'" [(selected)]="ev.src" (selectedChange)="videoSelected(elem, ev);elem.changes=true">
                                                <nb-option *ngFor="let file of userVideos" [value]=file.src>{{file.filename}}</nb-option>
                                            </nb-select>
                                            <nb-select placeholder="Select an audio" *ngIf="ev.select && ev.type==='audio'" [(selected)]="ev.src" (selectedChange)="videoSelected(elem, ev);elem.changes=true">
                                                <nb-option *ngFor="let file of userAudios" [value]=file.src>{{file.filename}}</nb-option>
                                            </nb-select>
                                            <app-uploader *ngIf="ev.upload" width="240px" height="120px" [autoIndexing]="true" [uploaded]="uploadedSubject" [reference]="{elem: elem, ev: ev}"></app-uploader>
                                            <button nbButton class="file-select" status="success" nbTooltip="Select file from existing" nbTooltipStatus="success" (click)="getUserSelectableFiles(ev)"><nb-icon icon="book-open"></nb-icon></button>
                                            <button nbButton  class="file-upload" status="warning" nbTooltip="Upload a new file" nbTooltipStatus="warning" (click)="ev.upload=true; ev.select = false"><nb-icon icon="cloud-upload"></nb-icon></button>
                                        </div>

                                        <div *ngIf="ev.src && ev.mediaInformation" class="video-details">
                                            <div *ngIf="ev.mediaInformation.width">Width: {{ev.mediaInformation.width}}px</div>
                                            <div *ngIf="ev.mediaInformation.height">Height: {{ev.mediaInformation.height}}px</div>
                                            <div>Duration: {{ev.mediaInformation.duration | number: '1.1-1'}}s</div>
                                        </div>

                                        <div class="video-settings">
                                            <nb-list *ngIf="ev.type==='video'">
                                                <nb-list-item>
                                                    <nb-checkbox [(ngModel)]="ev.withPrevious" [disabled]="i===0">Don't wait for previous</nb-checkbox>
                                                </nb-list-item>
                                                <nb-list-item *ngFor="let s of _videoSettings | keyvalue">
                                                    <div class="key">{{s.key}}</div>
                                                    <div class="value" *ngIf="s.value==='number'">
                                                        <input nbInput type="number" [(ngModel)]="ev[s.key]" fullWidth>
                                                        <div class="unit">px</div>
                                                    </div>
                                                    <div class="value" *ngIf="s.value === 'POSITION'">
                                                        <nb-select [(selected)]="ev.position">
                                                            <nb-option *ngFor="let p of _POSITION" [value]="p">{{p}}</nb-option>
                                                        </nb-select>
                                                    </div>
                                                </nb-list-item>
                                            </nb-list>
                                            <nb-list *ngIf="ev.type==='audio'">
                                                <nb-list-item>
                                                    <nb-checkbox [(ngModel)]="ev.withPrevious" [disabled]="i===0">Don't wait for previous</nb-checkbox>
                                                </nb-list-item>
                                                <nb-list-item *ngFor="let s of _audioSettings | keyvalue">
                                                    <div class="key">{{s.key}}</div>
                                                    <div class="value" *ngIf="s.value==='number'">
                                                        <input nbInput type="number" [(ngModel)]="ev[s.key]" fullWidth>
                                                        <div class="unit">px</div>
                                                    </div>
                                                    <div class="value" *ngIf="s.value === 'POSITION'">
                                                        <nb-select [(selected)]="ev.position">
                                                            <nb-option *ngFor="let p of _POSITION" [value]="p">{{p}}</nb-option>
                                                        </nb-select>
                                                    </div>
                                                </nb-list-item>
                                            </nb-list>
                                        </div>

                                    </div>

                                    <div #tts *ngIf="ev.type==='tts'" class="tts-container">

                                        <nb-select [(selected)]="ev.voice" placeholder="Select which voice to use">
                                            <nb-option *ngFor="let v of __ttsVoices | keyvalue" [value]="v.key">{{v.value}}</nb-option>
                                        </nb-select>

                                        <nb-select [(selected)]="ev.message" placeholder="Select what to read">
                                            <nb-option *ngFor="let o of _ttsOptions | keyvalue" [value]="o.key">{{o.value}}</nb-option>
                                        </nb-select>

                                        <nb-checkbox [(ngModel)]="ev.withPrevious" [disabled]="i===0">Don't wait for previous</nb-checkbox>

                                    </div>
                                
                                    <div #message *ngIf="ev.type==='message'" class="message-container">
                                        message
                                    </div>

                                    <div #gif *ngIf="ev.type==='gif'" class="gif-container">
                                        gif
                                    </div>

                                </nb-tab>
                                <nb-tab tabIcon="file-add">
                                    <nb-select placeholder="Select type of event" fullWidth [(selected)]="_singleSelection" (selectedChange)="addElement(elem, $event)">
                                        <nb-option *ngFor="let type of EventTypes | keyvalue" [value]="type.key">{{type.value}}</nb-option>
                                    </nb-select>
                                </nb-tab>
                                <nb-tab tabIcon="trash-2" [disabled]="!elem.events || elem.events.length<1">
                                    <nb-select placeholder="Select event to delete" fullWidth [(selected)]="_singleSelection" (selectedChange)="deleteEvent(elem, $event)">
                                        <nb-option *ngFor="let ev of elem.events; let i = index" [value]="i">{{ev.type}}</nb-option>
                                    </nb-select>
                                </nb-tab>
                            </nb-tabset>
                        </nb-card-body>

                        <nb-card-footer *ngIf="elem.error" class="event-error">
                            There were errors in your event's settings... Could not save it!
                        </nb-card-footer>

                        <nb-card-footer class="element-footer">
                            <button nbButton status="warning" [disabled]="!elem.changes" (click)="revertElement(elem)"><nb-icon icon="refresh"></nb-icon></button>
                            <button nbButton status="success" [disabled]="!elem.changes" (click)="saveElement(elem)">SAVE</button>
                            <button nbButton status="danger" (click)="deleteElement(elem)"><nb-icon icon="trash-2"></nb-icon></button>
                        </nb-card-footer>
                    </nb-card>
                </nb-accordion-item-body>
            </nb-accordion-item>
        </nb-accordion>

        <nb-card class="add-element-card">
            <nb-card-body>
                <button nbButton status="success" fullWidth (click)="addNewElement()">ADD NEW EVENT</button>
            </nb-card-body>
        </nb-card>

    </nb-layout-column>
</nb-layout>